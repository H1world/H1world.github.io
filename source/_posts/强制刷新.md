---
title: 强制刷新
date: 2019-03-16 22:50:18
categories: 随笔
tags: [react,前端]
---
  react强制刷新小姿势 plan2
<!--more-->
### 为什么要强制刷新？
今儿在公司加班赶进度，碰到了一个问题。加上我技术上的缺陷，经验上的不足以及恶心的项目逻辑和历史遗留问题，苦恼了一会儿。好在我的组长大哥及时分享了一个方案。及时记录下来，以免生疏。

在混合开发的场景：A页面有多种状态由后台接口返回，如` start=0；start=1；staet=2 `，每种状态展示UI不同，初始状态为start=0。然后由`A => B`页面跳转，再由`B => A`,此时A页面接收数据为start=1。但是由于浏览器缓存优化，导致无法触发componentDidMount等生命周期触发接口。
#### 组长分享的解决方案：
```Js
// index.html：中添加一个dom监听
  <input id="is-reload" type="hidden" value="1"/>
```
```Js
  // 创建全局方法获取此dom并且改变其值，并且在A组件内引用。
  export const reLoad = () => {
  const isReload = document.getElementById('is-reload')
  if (+isReload.value !== 1) {
    const RELOAD_ID = parseInt(Math.random() * 1000)
    const { origin, pathname, search, href } = window.location
    const hasId = getUrlParam('RELOAD_ID')
    let url = ''
    if (search) {
      url = origin + pathname + (hasId ? search.replace(/RELOAD_ID=[0-9]{3}/, `RELOAD_ID=${RELOAD_ID}`) : `${search}&RELOAD_ID=${RELOAD_ID}`)
    } else {
      url = href + `?RELOAD_ID=${RELOAD_ID}`
    }
    window.location.replace(url)
  } else {
    isReload.value = 2
  }
}
// A组件
import { reLoad } from "reLoad.js";
@reLoad
export default class A extends Component {}
```
#### 自己衍生的想法
react16.3之后版本删除了componentwillreceiveprops生命周期改为getDerivedStateFromProps监控props与start。想法，可以通过`mobx`或者`redux`中存入一个全局key值，然后通过getDerivedStateFromProps监控数据，重新请求接口改变start。
```js
  // mobx
  class mobxData {
    @observable type = 0;
  }
  // A组件
  import { inject, observer } from "mobx-react";
  @inject('mobxData')
  @observer
  export default class A extends Component  {
    state = {
      typeStart: this.props.mobxData.type
    };
   getDerivedStateFromProps(props,state){
     // 在此处判断Mobx是否与之前存储的数据相同 如果不是 则重新请求接口
     if (props.mobxData.type !== state.typeStart) {
       this.function()
     }
   }
  }
  // B组件
  import { inject, observer } from "mobx-react";
  @inject('mobxData')
  @observer
  export default class B extends Component  {
    componentDidMount(){
      this.props.mobxData.type = 1;
    }
  }
```
由于我的项目比较特殊，不便修改B组件。所以使用第一种强制刷新，但是总感觉不够react。真希望产品不要半路拦腰加需求